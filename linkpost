#!/Users/cbeck/.asdf/installs/nodejs/24.3.0/bin/node

const fs = require('fs');
const path = require('path');
const cheerio = require('cheerio');

// Simple HTML title extraction without external dependencies
function extractTitle(html) {
  const titleMatch = html.match(/\u003ctitle[^\u003e]*\u003e([^\u003c]+)\u003c\/title\u003e/i);
  return titleMatch ? titleMatch[1].trim() : 'Untitled';
}

// Extract summary from HTML using semantic tags
function extractSummary(html) {
  const $ = cheerio.load(html);
  let summary = '';
  
  // Try semantic tags in order of preference
  const semanticSelectors = [
    'article p:first-of-type',
    'main p:first-of-type', 
    '[role="main"] p:first-of-type',
    '.content p:first-of-type',
    '#content p:first-of-type',
    'section p:first-of-type',
    'p:first-of-type'
  ];
  
  for (const selector of semanticSelectors) {
    const element = $(selector).first();
    if (element.length > 0) {
      let text = element.text().trim();
      // Clean up the text and limit to 1-3 sentences
      text = text.replace(/\s+/g, ' '); // Normalize whitespace
      const sentences = text.split(/[.!?]+/);
      summary = sentences.slice(0, 3).join('. ').trim();
      if (summary && summary.length > 20) { // Ensure meaningful content
        if (!summary.endsWith('.') && !summary.endsWith('!') && !summary.endsWith('?')) {
          summary += '.';
        }
        break;
      }
    }
  }
  
  return summary || 'Summary not available.';
}

// Create a URL-friendly slug from title
function createSlug(title) {
  return title
    .toLowerCase()
    .replace(/[^a-z0-9\s-]/g, '') // Remove special characters
    .replace(/\s+/g, '-')         // Replace spaces with hyphens
    .replace(/-+/g, '-')          // Replace multiple hyphens with single
    .replace(/^-|-$/g, '');       // Remove leading/trailing hyphens
}

async function scrapeAndCreateLinkpost(url) {
  try {
    console.log(`Fetching: ${url}`);
    
    const response = await fetch(url);
    if (!response.ok) {
      throw new Error(`HTTP error! status: ${response.status}`);
    }
    
    const html = await response.text();
    const title = extractTitle(html);
    const summary = extractSummary(html);
    const slug = createSlug(title);
    const date = new Date().toISOString().split('T')[0];
    const filename = `${date}-${slug}.markdown`;

    // Ensure _posts directory exists
    const postsDir = path.join(__dirname, '_posts');
    if (!fs.existsSync(postsDir)) {
      fs.mkdirSync(postsDir, { recursive: true });
    }

    const filePath = path.join(postsDir, filename);
    const content = `---
layout: post
title: "${title}"
date: ${date}
linkhref: ${url}
categories:
---

[{{ page.title }}]({{ page.linkhref }})

${summary}

`;

    fs.writeFileSync(filePath, content);
    console.log(`‚úÖ Linkpost created: ${filename}`);
    console.log(`üìÑ Title: ${title}`);
    console.log(`üîó URL: ${url}`);
    console.log(`üìç Location: ${filePath}`);
    
  } catch (error) {
    console.error('‚ùå Error:', error.message);
    process.exit(1);
  }
}

// Get the URL from command line arguments
const [,, url] = process.argv;

if (!url) {
  console.error('Usage: ./linkpost <URL>');
  console.error('Example: ./linkpost https://example.com');
  process.exit(1);
}

// Validate URL format
try {
  new URL(url);
} catch {
  console.error('‚ùå Invalid URL format');
  process.exit(1);
}

scrapeAndCreateLinkpost(url);
